<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Tableau de bord Médecin</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding" id="main-content">
  @if (isLoading) {
    <ion-spinner name="crescent" class="loading-spinner"></ion-spinner>
  }

  @if (!isLoading) {
    @if (errorMessage) {
      <ion-text color="danger">{{ errorMessage }}</ion-text>
    }

    <ion-card>
      <ion-card-header>
        <ion-card-title>Profil</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-avatar slot="start">
            <img [src]="profile.photo || 'assets/default-doctor.jpg'" alt="Profile Photo">
          </ion-avatar>
          <ion-label>
            <h3>{{ profile.name }} {{ profile.surname }}</h3>
            <p>{{ profile.specialty }}</p>
            <p>{{ profile.city }}</p>
          </ion-label>
        </ion-item>
        <ion-item>
          <ion-label>Photo de profil</ion-label>
          <input type="file" accept="image/*" (change)="uploadPhoto($event)" />
        </ion-item>
        <ion-item>
          <ion-label position="floating">Nom</ion-label>
          <ion-input [(ngModel)]="profile.name"></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="floating">Prénom</ion-label>
          <ion-input [(ngModel)]="profile.surname"></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="floating">Email</ion-label>
          <ion-input type="email" [(ngModel)]="profile.email"></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="floating">Spécialité</ion-label>
          <ion-input [(ngModel)]="profile.specialty"></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="floating">Ville</ion-label>
          <ion-input [(ngModel)]="profile.city"></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="floating">Nouveau mot de passe</ion-label>
          <ion-input type="password" [(ngModel)]="password"></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="floating">Confirmer le mot de passe</ion-label>
          <ion-input type="password" [(ngModel)]="confirmPassword"></ion-input>
        </ion-item>
        <ion-button expand="full" color="primary" (click)="updateProfile()">Mettre à jour le profil</ion-button>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Messages</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          @for (contact of contacts; track contact._id) {
            <ion-item button (click)="selectContact(contact)">
              <ion-label>
                <h3>{{ contact.name }} {{ contact.surname }}</h3>
                <p>{{ contact.email }}</p>
              </ion-label>
            </ion-item>
          }
        </ion-list>
        @if (selectedContact) {
          <ion-card>
            <ion-card-header>
              <ion-card-title>Conversation avec {{ selectedContact.name }} {{ selectedContact.surname }}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-list>
                @for (message of messages; track message._id) {
                  <ion-item>
                    <ion-label>
                      <h3>{{ message.sender_id === profile._id ? 'Vous' : selectedContact.name }}: {{ message.content }}</h3>
                      <p>{{ message.created_at | date:'short' }}</p>
                    </ion-label>
                  </ion-item>
                }
              </ion-list>
              <ion-item>
                <ion-input [(ngModel)]="newMessage" placeholder="Écrire un message..."></ion-input>
                <ion-button slot="end" (click)="sendMessage()">Envoyer</ion-button>
              </ion-item>
            </ion-card-content>
          </ion-card>
        }
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Options</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-button expand="full" color="medium" (click)="goToAppointments()">
          <ion-icon name="calendar-outline" slot="start"></ion-icon>
          Voir les rendez-vous
        </ion-button>
        <ion-button expand="full" color="medium" (click)="goToNotifications()">
          <ion-icon name="notifications-outline" slot="start"></ion-icon>
          Voir les notifications
        </ion-button>
        <ion-button expand="full" color="medium" (click)="goToSettings()">
          <ion-icon name="settings-outline" slot="start"></ion-icon>
          Paramètres
        </ion-button>
        <ion-button expand="full" color="danger" (click)="logout()">
          <ion-icon name="log-out-outline" slot="start"></ion-icon>
          Déconnexion
        </ion-button>
      </ion-card-content>
    </ion-card>
  }
</ion-content>